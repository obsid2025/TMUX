#!/bin/bash
# tp - Tmux Projects
# Fiecare folder/proiect = server tmux izolat
# Cu auto-save È™i auto-restore

PROJECT_NAME=$(basename "$PWD")
SAVE_DIR="$HOME/.tmux/project-saves"

mkdir -p "$SAVE_DIR"

# FuncÈ›ie pentru auto-restore dacÄƒ serverul nu ruleazÄƒ
auto_restore() {
    if ! tmux -L "$PROJECT_NAME" has-session 2>/dev/null; then
        if [ -f "$SAVE_DIR/$PROJECT_NAME.sessions" ] && [ -s "$SAVE_DIR/$PROJECT_NAME.sessions" ]; then
            echo "Auto-restaurare proiect '$PROJECT_NAME'..."
            while read session; do
                [ -z "$session" ] && continue
                tmux -L "$PROJECT_NAME" new-session -d -s "$session" -c "$PWD" 2>/dev/null
            done < "$SAVE_DIR/$PROJECT_NAME.sessions"

            if [ -f "$SAVE_DIR/$PROJECT_NAME.windows" ]; then
                while IFS=: read session window; do
                    [ -z "$session" ] && continue
                    tmux -L "$PROJECT_NAME" new-window -t "$session" -n "$window" 2>/dev/null
                done < "$SAVE_DIR/$PROJECT_NAME.windows"
            fi
            echo "Restaurat!"
        fi
    fi
}

# FuncÈ›ie pentru salvare
do_save() {
    if tmux -L "$PROJECT_NAME" has-session 2>/dev/null; then
        tmux -L "$PROJECT_NAME" list-sessions -F "#{session_name}" > "$SAVE_DIR/$PROJECT_NAME.sessions"
        tmux -L "$PROJECT_NAME" list-windows -a -F "#{session_name}:#{window_name}" > "$SAVE_DIR/$PROJECT_NAME.windows"
    fi
}

# FuncÈ›ie pentru attach/create sesiune
attach_or_create() {
    local SESSION_NAME="${1:-main}"
    auto_restore
    if tmux -L "$PROJECT_NAME" has-session -t "$SESSION_NAME" 2>/dev/null; then
        do_save
        tmux -L "$PROJECT_NAME" attach -t "$SESSION_NAME"
        do_save
    else
        tmux -L "$PROJECT_NAME" new-session -s "$SESSION_NAME" -c "$PWD"
        do_save
    fi
}

case "$1" in
    "")
        auto_restore
        if tmux -L "$PROJECT_NAME" has-session 2>/dev/null; then
            do_save
            tmux -L "$PROJECT_NAME" attach
            do_save
        else
            tmux -L "$PROJECT_NAME" new-session -s main -c "$PWD"
            do_save
        fi
        ;;
    ls)
        auto_restore
        tmux -L "$PROJECT_NAME" ls 2>/dev/null || echo "Nicio sesiune Ã®n proiectul '$PROJECT_NAME'"
        ;;
    ls-all)
        echo "Proiecte active:"
        for sock in /tmp/tmux-$(id -u)/*; do
            [ -S "$sock" ] || continue
            name=$(basename "$sock")
            echo "  ðŸ“ $name"
            tmux -L "$name" ls 2>/dev/null | sed 's/^/      /'
        done
        ;;
    new)
        auto_restore
        tmux -L "$PROJECT_NAME" new-window -n "$2" -c "$PWD"
        do_save
        ;;
    rename)
        tmux -L "$PROJECT_NAME" rename-window "$2"
        do_save
        echo "FereastrÄƒ redenumitÄƒ: $2"
        ;;
    rename-session)
        tmux -L "$PROJECT_NAME" rename-session -t "$2" "$3"
        do_save
        echo "Sesiune '$2' redenumitÄƒ Ã®n '$3'"
        ;;
    create)
        auto_restore
        SESSION_NAME="${2:-main}"
        tmux -L "$PROJECT_NAME" new-session -d -s "$SESSION_NAME" -c "$PWD"
        do_save
        echo "Sesiune '$SESSION_NAME' creatÄƒ Ã®n proiectul '$PROJECT_NAME'"
        ;;
    kill)
        tmux -L "$PROJECT_NAME" kill-server 2>/dev/null
        echo "Proiect '$PROJECT_NAME' oprit (salvarea rÄƒmÃ¢ne pentru restore)"
        ;;
    kill-session)
        tmux -L "$PROJECT_NAME" kill-session -t "$2" 2>/dev/null
        do_save
        echo "Sesiune '$2' È™tearsÄƒ"
        ;;
    send)
        shift
        tmux -L "$PROJECT_NAME" send-keys "$@"
        ;;
    save)
        do_save
        echo "Proiect '$PROJECT_NAME' salvat"
        ;;
    restore)
        auto_restore
        tmux -L "$PROJECT_NAME" ls 2>/dev/null || echo "Nimic de restaurat"
        ;;
    help|--help|-h)
        echo "tp - Tmux Projects (izolate per folder, cu auto-save/restore)"
        echo ""
        echo "Folosire:"
        echo "  tp                  Attach la proiect (auto-restore)"
        echo "  tp SESIUNE          Attach/creazÄƒ sesiune cu nume"
        echo "  tp create NUME      CreazÄƒ sesiune (fÄƒrÄƒ attach)"
        echo "  tp ls               Lista sesiuni (auto-restore)"
        echo "  tp ls-all           Lista TOATE proiectele"
        echo "  tp new WINDOW       CreazÄƒ fereastrÄƒ nouÄƒ"
        echo "  tp rename NUME      RedenumeÈ™te fereastra"
        echo "  tp rename-session OLD NEW  RedenumeÈ™te sesiunea"
        echo "  tp save             SalveazÄƒ manual"
        echo "  tp kill             OpreÈ™te proiectul"
        echo "  tp kill-session X   È˜terge sesiunea X"
        echo ""
        echo "Proiect curent: $PROJECT_NAME"
        echo "Auto-save: la fiecare operaÈ›iune"
        echo "Auto-restore: cÃ¢nd serverul nu ruleazÄƒ"
        ;;
    *)
        attach_or_create "$1"
        ;;
esac
